\section{Model specification}\label{chapter-04:section:model-specification}

\subsection{The \texttt{@model} language}

The RxInfer framework utilizes a specialized language to specify a model $p(\bm{y},
  \bm{s})$ through a macro called \jlinl{@model}.
The \jlinl{@model} macro parses a textual description of a probabilistic model and constructs
the corresponding factor graph.
This macro can be considered a \ac{dsl} specifically designed for the specification of probabilistic models.
It is designed to resemble existing Julia libraries for probabilistic model specification
while also providing flexibility to support reactive message passing-based inference,
factorization, and formulation of constraints for variational families $\mathcal{Q}_{B}$ from~\eqref{eq:bfe:factorized_bethe}.

To illustrate the usage of the \jlinl{@model} macro, let us consider a simple problem of
inferring the bias of a coin based on a sequence of coin flips.
We can reasonably assume that each coin flip outcome $y_i$ follows a Bernoulli distribution
\begin{equation}
y_i \sim \mathrm{Bernoulli}(\theta),
\end{equation} where $y_i \in \{ 1, 0 \}$ represents "heads" and "tails" respectively.
The underlying probability of obtaining heads for a single coin flip is denoted as $\theta \in
  [0, 1]$ and is considered a hidden (unobserved) state.

The probabilistic model can then be defined as a joint probability \begin{equation}
\label{eq:rxi:coin_model}
p(\bm{y}, \theta) = p(\theta) \prod_{i=1}^{N} p(y_i\vert \theta),
\end{equation}
where $N$ represents the length of the observed coin flip sequence.

Listing~\ref{lst:rxi:graphppl_first_example} demonstrates an example of the model
specification syntax for the model defined in~\eqref{eq:rxi:coin_model}.
The code generated by the \jlinl{@model} macro in Listing~\ref{lst:rxi:graphppl_first_example}
automatically creates a factor graph, as illustrated in Figure~\ref{fig:rxi:coin_model}.
\begin{figure*}[h!]
  \begin{adjustbox}{minipage=\textwidth,margin=0pt \smallskipamount,center}
    \jlinputlisting[label={lst:rxi:graphppl_first_example}, caption={An example of a probabilistic model specification using the \jlinl{@model} macro for a simple coin flip model~\eqref{eq:rxi:coin_model}.
          The code, generated by the \jlinl{@model} macro specification, automatically creates a factor
          graph depicted in Figure~\ref{fig:rxi:coin_model}.
        },captionpos=b]{contents/04-rxinfer/code/02-coin-model.jl}
  \end{adjustbox}
\end{figure*}

\begin{figure}
  \centering
  \resizebox{0.9\textwidth}{!}{\input{contents/04-rxinfer/figs/02-coin-model}}
  \caption{An automatically generated \ac{tffg} by the \texttt{@model} macro in Listing~\ref{lst:rxi:graphppl_first_example} for the probabilistic model~\eqref{eq:rxi:coin_model}.
  The $p_\theta$ factor represents a prior probability distribution for the $\theta$ variable.
    The $\cdots$ symbol indicates the repetition of the same structure for all $N$ coin flips.
  }
  \label{fig:rxi:coin_model}
\end{figure}

\subsection{Observed states}

To incorporate observations $\bm{y}$ into a model, the language provides the
\jlinl{datavar(T)} function, where \jlinl{T} represents the type of data, such as
\jlinl{Float64} or \jlinl{Vector\{Float64\}}.
These variables are constrained to have posterior distributions in the form of delta
distributions and act as "clamped" nodes in the model.
The model automatically reacts to these observations and performs inference as soon as new
data become available, see Listing~\ref{lst:rxi:graphppl_datavar}.
\begin{figure*}[h!]
  \begin{adjustbox}{minipage=\textwidth,margin=0pt \smallskipamount,center}
    \jlinputlisting[label={lst:rxi:graphppl_datavar}, caption={
          The \jlinl{datavar} function marks variables as observations and constrains their posteriors to be in the form of delta distributions.
          The function takes a type specification as its first argument and optionally accepts dimensionality as additional arguments or as a tuple.
          The inference automatically reacts to changes in the data variables and updates the posteriors accordingly.
        },captionpos=b]{contents/04-rxinfer/code/02-model-datavar.jl}
  \end{adjustbox}
\end{figure*}

\subsection{Latent states}

On the other hand, the \jlinl{randomvar()} function is used to create latent states $\bm{s}$
in a probabilistic model as random variables, see Listing~\ref{lst:rxi:graphppl_randomvar}.
It is important to note that it is not necessary to call the \jlinl{randomvar()} function for
every latent state in the model, as the model specification language often identifies
variables representing latent states automatically.
\begin{figure*}[h!]
  \begin{adjustbox}{minipage=\textwidth,margin=0pt \smallskipamount,center}
    \jlinputlisting[label={lst:rxi:graphppl_randomvar}, caption={
          One way to create latent states in a model is by explicitly calling the \jlinl{randomvar()} function.
          By default, it creates a single random variable in the model and returns it.
          Additionally, dimensionality arguments can be passed to the \jlinl{randomvar()} function in the same way as for the \jlinl{datavar()} function.
        },captionpos=b]{contents/04-rxinfer/code/02-model-randomvar.jl}
  \end{adjustbox}
\end{figure*}

\subsection{The ``tilde'' operator}

The tilde operator ($\sim$) establishes a functional relationship between variables in a
model, see Listing~\ref{lst:rxi:graphppl_tilde}.
It can be interpreted as "is sampled from" or "is modeled by".
For instance, an expression such as \jlinl{y ~ Bernoulli(Î¸)} can be understood as "$y$ is
modeled by the Bernoulli distribution with parameter $\theta$".
\begin{figure*}[h!]
  \begin{adjustbox}{minipage=\textwidth,margin=0pt \smallskipamount,center}
    \jlinputlisting[label={lst:rxi:graphppl_tilde}, caption={
          The $\sim$ operator is used to model a variable with a probability distribution.
          In the code example, observations $\bm{y}$ are modeled by the Normal distribution, where the mean and precision parameters are controlled by the random variables $\mu$ and $\gamma$,
          respectively.
        },captionpos=b]{contents/04-rxinfer/code/02-model-tilde.jl}
  \end{adjustbox}
\end{figure*}

